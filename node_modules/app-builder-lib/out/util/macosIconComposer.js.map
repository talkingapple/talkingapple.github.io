{"version":3,"file":"macosIconComposer.js","sourceRoot":"","sources":["../../src/util/macosIconComposer.ts"],"names":[],"mappings":"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","sourcesContent":["// Adapted from https://github.com/electron/packager/pull/1806\n\nimport { spawn } from \"builder-util\"\nimport * as fs from \"fs/promises\"\nimport * as os from \"node:os\"\nimport * as path from \"node:path\"\nimport * as plist from \"plist\"\nimport * as semver from \"semver\"\n\nexport interface AssetCatalogResult {\n  assetCatalog: Buffer\n  icnsFile: Buffer\n}\n\nconst INVALID_ACTOOL_VERSION_ERROR = new Error(\n  \"Failed to check actool version. Is Xcode 26 or higher installed? See output of the `actool --version` CLI command for more details.\"\n)\n\nasync function checkActoolVersion(tmpDir: string) {\n  const acToolOutputFileName = path.resolve(tmpDir, \"actool.log\")\n\n  let versionInfo: Record<string, Record<string, string>> | undefined = undefined\n\n  let acToolOutputFile: fs.FileHandle | null = null\n  let errorQueued: Error | null = null\n  try {\n    acToolOutputFile = await fs.open(acToolOutputFileName, \"w\")\n    await spawn(\"actool\", [\"--version\"], { stdio: [\"ignore\", acToolOutputFile.fd, acToolOutputFile.fd] })\n    const acToolVersionOutput = await fs.readFile(acToolOutputFileName, \"utf8\")\n    versionInfo = plist.parse(acToolVersionOutput) as Record<string, Record<string, string>>\n  } catch (e: any) {\n    errorQueued = e\n  } finally {\n    if (acToolOutputFile) {\n      await acToolOutputFile.close()\n    }\n  }\n\n  if (errorQueued || !versionInfo || !versionInfo[\"com.apple.actool.version\"] || !versionInfo[\"com.apple.actool.version\"][\"short-bundle-version\"]) {\n    throw INVALID_ACTOOL_VERSION_ERROR\n  }\n\n  const acToolVersion = versionInfo[\"com.apple.actool.version\"][\"short-bundle-version\"]\n  if (!semver.gte(semver.coerce(acToolVersion)!, \"26.0.0\")) {\n    throw new Error(`Unsupported actool version. Must be on actool 26.0.0 or higher but found ${acToolVersion}. Install Xcode 26 or higher to get a supported version of actool.`)\n  }\n}\n\n/**\n * Generates an asset catalog and extra assets that are useful for packaging the app.\n * @param inputPath The path to the `.icon` file\n * @returns The asset catalog and extra assets\n */\nexport async function generateAssetCatalogForIcon(inputPath: string): Promise<AssetCatalogResult> {\n  const tmpDir = await fs.mkdtemp(path.resolve(os.tmpdir(), \"icon-compile-\"))\n  const cleanup = async () => {\n    await fs.rm(tmpDir, {\n      recursive: true,\n      force: true,\n    })\n  }\n\n  try {\n    await checkActoolVersion(tmpDir)\n  } catch (error) {\n    await cleanup()\n    throw error\n  }\n\n  const iconPath = path.resolve(tmpDir, \"Icon.icon\")\n  const outputPath = path.resolve(tmpDir, \"out\")\n\n  try {\n    await fs.cp(inputPath, iconPath, {\n      recursive: true,\n    })\n\n    await fs.mkdir(outputPath, {\n      recursive: true,\n    })\n\n    await spawn(\"actool\", [\n      iconPath,\n      \"--compile\",\n      outputPath,\n      \"--output-format\",\n      \"human-readable-text\",\n      \"--notices\",\n      \"--warnings\",\n      \"--output-partial-info-plist\",\n      path.resolve(outputPath, \"assetcatalog_generated_info.plist\"),\n      \"--app-icon\",\n      \"Icon\",\n      \"--include-all-app-icons\",\n      \"--accent-color\",\n      \"AccentColor\",\n      \"--enable-on-demand-resources\",\n      \"NO\",\n      \"--development-region\",\n      \"en\",\n      \"--target-device\",\n      \"mac\",\n      \"--minimum-deployment-target\",\n      \"26.0\",\n      \"--platform\",\n      \"macosx\",\n    ])\n\n    const assetCatalog = await fs.readFile(path.resolve(outputPath, \"Assets.car\"))\n    const icnsFile = await fs.readFile(path.resolve(outputPath, \"Icon.icns\"))\n\n    return { assetCatalog, icnsFile }\n  } finally {\n    await cleanup()\n  }\n}\n"]}